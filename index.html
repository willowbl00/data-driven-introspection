<!--currently loads data only from September and outputs each activity as a bar in a chart via d3.
Next goals are to combine into by-week or by-month, and to separate out rides from runs. Then to do over more time.-->

<!DOCTYPE html>
<meta charset="utf-8">
<style>

.chart text {
  fill: white;
  font: 10px sans-serif;
  text-anchor: end;
}

.run {
	fill: red;
}
.ride {
	fill: blue;
}

</style>
<head></head>
<body>
<!-- This is where we call the chart -->
	<svg class="chart"></svg>
	<div id = "myDiv"></div>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script>
//this is where we are defining dates
	var startDate = new Date('September 1, 2017');
	var endDate = new Date('September 30, 2017');
	console.log(startDate.getTime());
	console.log(endDate.getTime());

//this is where we call the data
	function loadXMLDoc() {
	    var xmlhttp = new XMLHttpRequest();

	    xmlhttp.onreadystatechange = function() {
	        if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
	           if (xmlhttp.status == 200) {
	               // document.getElementById("myDiv").innerHTML = xmlhttp.responseText;
	               septRuns = JSON.parse(xmlhttp.responseText);
	               getSeptRuns(septRuns);
	           }
	           else if (xmlhttp.status == 400) {
	              alert('yo dog there was a problem');
	           }
	           else {
	               alert('something else other than 200 was returned what does that even mean');
	           }
	        }
	    };
// remember to remove the below when committing and/or switch to oAuth
	    xmlhttp.open("GET", "https://www.strava.com/api/v3/athlete/activities?access_token=ACCESSTOKEN", true);
	    xmlhttp.send();
	}
	loadXMLDoc();

//this is where we loop through the data
	function getSeptRuns(septRuns){
		var totals = {"runTotal":0,"rideTotal":0};
		var runTotal = 0;
		var rideTotal = 0;
		for(var i=0; i<septRuns.length; i++){
		//we want an if statement here to separate for just September, as defined
			var activityDate = new Date(septRuns[i].start_date);
			if(activityDate > startDate && activityDate < endDate){
				// data.push((septRuns[i].distance*0.0006213712).toFixed(2));	
				//converting from meters to miles, rounding to 2 decimal places
				var distance = parseFloat((septRuns[i].distance*0.0006213712).toFixed(2));
				console.log(distance)
				console.log(typeof(distance))
				if(septRuns[i].type === "Run"){
					totals.runTotal+=distance;
					runTotal+=distance
				}
				if(septRuns[i].type === "Ride"){
					totals.rideTotal+=distance;
					rideTotal+=distance
				}
			}
		}
		//this is the chart
		var data = [{"runTotal":runTotal},{"rideTotal":rideTotal}]
		var width = 420,
		barHeight = 20;

		var x = d3.scale.linear()
	   	 .domain([0, 100])
	   	 .range([0, 400]);

		var chart = d3.select(".chart")
		    .attr("width", width)
		    .attr("height", barHeight * data.length);

		var bar = chart.selectAll("g")
		    .data(data)
		  .enter().append("g")
		    .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });
		bar.append("rect")
			.attr("class", "run")
		    .attr("width", function(d){return x(d.runTotal);
		    })
		    .attr("height", barHeight - 1);

		bar.append("rect")
			.attr("class", "ride")
		    .attr("width", function(d){return x(d.rideTotal);
		    })
		    .attr("height", barHeight - 1);

		bar.append("text")
		    .attr("x", function(d) {return x(d.runTotal) - 3; })
		    .attr("y", barHeight / 2)
		    .attr("dy", ".35em")
		    .text(function(d) { return d.runTotal; });
		bar.append("text")
		    .attr("x", function(d) {return x(d.rideTotal) - 3; })
		    .attr("y", barHeight / 2)
		    .attr("dy", ".35em")
		    .text(function(d) { return d.rideTotal; });
		}

	</script>
</body>
